<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Blog - Aadityansha Verma</title>

    <link rel="icon" type="image/x-icon" href="pic/favicon.ico" />

    <script src="https://cdn.tailwindcss.com"></script>

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Patrick+Hand&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #fff1cb;
            --bg-secondary: #faedcd;
            --bg-card: rgba(255, 241, 203, 0.7);
            --bg-header: rgba(250, 237, 205, 0.85);
            --text-heading: #222;
            --text-body: #3c3c3c;
            --text-muted: #777;
            --accent-color: #ff5e6c;
            --accent-hover: #e84a58;
            --accent-subtle: rgba(255, 94, 108, 0.12);
            --accent-text: #b33c47;
            --border-color: #e8dcb6;
            --border-accent: rgba(255, 94, 108, 0.25);
            --code-bg: #2d3748;
            --code-border: #4a5568;
        }

        .theme-rose {
            --bg-primary: #19150f;
            --bg-secondary: #211c16;
            --bg-card: rgba(40, 35, 29, 0.5);
            --bg-header: rgba(25, 21, 15, 0.8);
            --text-heading: #eee;
            --text-body: #ddd;
            --text-muted: #ccc;
            --accent-color: #ff5e6c;
            --accent-hover: #fe3c4f;
            --accent-subtle: rgba(255, 94, 108, 0.15);
            --accent-text: #fca9b0;
            --border-color: #443c33;
            --border-accent: rgba(255, 94, 108, 0.3);
            --code-bg: #1a1a1a;
            --code-border: #333;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-body);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .humor-text {
            font-family: 'Patrick Hand', cursive;
            font-size: 0.9rem;
            color: var(--text-muted);
            opacity: 0.8;
            font-weight: 400;
        }

        .blog-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            /* Adjusted padding for mobile */
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .blog-card {
                padding: 2rem;
            }
        }


        .blog-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .blog-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .blog-title {
            color: var(--text-heading);
            font-weight: 700;
            margin: 1rem 0 0.5rem 0;
            line-height: 1.3;
        }

        .tech-tag {
            background: var(--accent-subtle);
            color: var(--accent-text);
            font-size: 0.7rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-primary);
            margin: 5vh auto;
            /* Changed for better vertical centering */
            padding: 0;
            border-radius: 12px;
            width: 95%;
            /* Adjusted for mobile */
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .close {
            color: var(--text-muted);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: var(--accent-color);
        }

        .article-content {
            padding: 1.5rem;
            /* Adjusted padding for mobile */
            line-height: 1.7;
        }

        @media (min-width: 768px) {
            .article-content {
                padding: 2rem;
            }
        }

        .article-content h2 {
            color: var(--text-heading);
            font-size: 1.8rem;
            font-weight: 700;
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-color);
        }

        .article-content h3 {
            color: var(--text-heading);
            font-size: 1.4rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
        }

        .article-content p {
            margin-bottom: 1.2rem;
            color: var(--text-body);
        }

        .article-content a {
            color: var(--accent-color);
            text-decoration: underline;
            font-weight: 600;
        }

        .article-content a:hover {
            color: var(--accent-hover);
        }

        .article-content pre {
            background: var(--code-bg) !important;
            border: 1px solid var(--code-border) !important;
            border-radius: 8px !important;
            padding: 1rem !important;
            margin: 1rem 0 !important;
            font-family: 'JetBrains Mono', monospace !important;
            font-size: 0.9rem !important;
            overflow-x: auto;
        }

        .article-content hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
            margin: 2rem 0;
        }

        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-body);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .share-buttons {
            display: flex;
            flex-wrap: wrap;
            /* Added for responsiveness */
            justify-content: center;
            /* Added for alignment */
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .share-btn {
            padding: 0.5rem 1rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 2000;
            overflow-y: auto;
        }

        .admin-header {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .toolbar-btn {
            padding: 0.5rem 0.75rem;
            background: var(--accent-subtle);
            color: var(--accent-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .humor-text {
            transition: color ease-in 0.3s;
        }

        .humor-text:hover {
            opacity: 1;
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-heading);
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-body);
            font-family: inherit;
        }

        .form-textarea {
            resize: vertical;
            min-height: 300px;
            font-family: 'JetBrains Mono', monospace;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #editor {
            height: 300px;
            background: var(--bg-card);
            color: var(--text-body);
        }

        .loading,
        .no-results {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="antialiased">
    <header
        class="bg-[var(--bg-header)] backdrop-blur-sm fixed top-0 left-0 right-0 z-50 border-b border-[var(--border-color)]">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between min-h-[4rem]"> <!-- Changed h-16 to min-h-[4rem] -->
                <div class="flex-shrink-0">
                    <a href="index.html"
                        class="flex items-center space-x-3 text-xl font-bold text-[var(--text-heading)] transition-colors duration-300 hover:text-[var(--accent-color)]">
                        <img src="https://avatars.githubusercontent.com/u/96714228?v=4" alt="Logo"
                            class="w-8 h-8 rounded-full border-2 border-[var(--border-accent)]">
                        <span>Aadityansha Verma</span>
                    </a>
                </div>
                <div class="flex items-center">
                    <nav class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="index.html"
                                class="px-3 py-2 rounded-md text-sm font-medium text-[var(--text-body)] hover:text-[var(--accent-color)] hover:bg-[var(--bg-card)] transition-all duration-300">Home</a>
                            <a href="index.html#about"
                                class="px-3 py-2 rounded-md text-sm font-medium text-[var(--text-body)] hover:text-[var(--accent-color)] hover:bg-[var(--bg-card)] transition-all duration-300">About</a>
                            <a href="#"
                                class="px-3 py-2 rounded-md text-sm font-medium text-[var(--accent-color)] bg-[var(--accent-subtle)] transition-all duration-300">Blog</a>
                            <button id="admin-toggle"
                                class="px-3 py-2 rounded-md text-sm font-medium text-[var(--text-body)] hover:text-[var(--accent-color)] hover:bg-[var(--bg-card)] transition-all duration-300">Admin</button>
                        </div>
                    </nav>
                    <button id="theme-toggle"
                        class="ml-4 p-2 rounded-full text-[var(--text-body)] hover:bg-[var(--bg-card)] focus:outline-none transition-colors duration-300">
                        <i class='bx bxs-moon text-xl'></i>
                    </button>
                    <!-- Mobile menu button -->
                    <div class="ml-2 md:hidden">
                        <button id="mobile-menu-button"
                            class="inline-flex items-center justify-center p-2 rounded-md text-[var(--text-body)] hover:text-white hover:bg-[var(--accent-color)] focus:outline-none">
                            <i id="mobile-menu-icon" class='bx bx-menu text-2xl'></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile menu, show/hide based on menu state. -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="index.html"
                    class="block px-3 py-2 rounded-md text-base font-medium text-[var(--text-body)] hover:text-[var(--accent-color)] hover:bg-[var(--bg-card)]">Home</a>
                <a href="index.html#about"
                    class="block px-3 py-2 rounded-md text-base font-medium text-[var(--text-body)] hover:text-[var(--accent-color)] hover:bg-[var(--bg-card)]">About</a>
                <a href="#"
                    class="block px-3 py-2 rounded-md text-base font-medium text-[var(--accent-color)] bg-[var(--accent-subtle)]">Blog</a>
                <button id="admin-toggle-mobile"
                    class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-[var(--text-body)] hover:text-[var(--accent-color)] hover:bg-[var(--bg-card)]">Admin</button>
            </div>
        </div>
    </header>

    <main class="pt-24">
        <section class="py-16 bg-gradient-to-br from-[var(--bg-primary)] to-[var(--bg-secondary)]">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-3xl md:text-5xl font-bold text-[var(--text-heading)] mb-4">
                    Breaking complexity into simplicity
                </h1>
                <p class="text-lg md:text-xl text-[var(--text-muted)] mb-2">
                    A dimension of my own thoughts and programming <span class="humor-text">(and my mistakes,so you
                        don't have to )</span>
                </p>
                <p class="text-[var(--accent-color)] font-medium">
                    programming, philosophy ,my work and insights
                </p>
            </div>
        </section>

        <section class="py-12 bg-[var(--bg-primary)]">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="search-container">
                    <i class='bx bx-search search-icon'></i>
                    <input type="text" id="search-input" class="search-input"
                        placeholder="Search articles, tags, or content...">
                </div>

                <div id="tag-filter" class="flex flex-wrap gap-2 justify-center mb-8">
                </div>
            </div>
        </section>

        <section class="py-20 bg-[var(--bg-primary)]">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="loading" id="loading">
                    <i class='bx bx-loader-alt bx-spin text-4xl text-[var(--accent-color)]'></i>
                    <p class="mt-4">Loading articles...</p>
                </div>

                <div class="no-results" id="no-results">
                    <i class='bx bx-search-alt text-4xl text-[var(--text-muted)] mb-4'></i>
                    <p>No articles found matching your search.</p>
                </div>

                <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                </div>
            </div>
        </section>
    </main>

    <div id="article-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="text-xl md:text-2xl font-bold text-[var(--text-heading)]"></h2>
                <span class="close" id="close-modal">&times;</span>
            </div>
            <div class="article-content">
                <div id="modal-meta" class="text-center mb-8">
                    <div id="modal-date" class="blog-meta"></div>
                    <div id="modal-tags" class="flex justify-center flex-wrap gap-2 mt-4 mb-6"></div>
                    <div class="share-buttons justify-center">
                        <button class="share-btn" onclick="shareArticle('twitter')">
                            <i class='bx bxl-twitter'></i> Twitter
                        </button>
                        <button class="share-btn" onclick="shareArticle('linkedin')">
                            <i class='bx bxl-linkedin'></i> LinkedIn
                        </button>
                        <button class="share-btn" onclick="shareArticle('copy')">
                            <i class='bx bx-copy'></i> Copy Link
                        </button>
                    </div>
                </div>
                <div id="modal-content-body"></div>
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; margin-top: 10%;">
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-[var(--text-heading)]">Admin Login</h2>
                <span class="close" id="close-login">&times;</span>
            </div>
            <div class="p-6">
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="login-email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="login-password" class="form-input" required>
                    </div>
                    <button type="submit" id="login-btn" class="w-full share-btn">
                        <i class='bx bx-log-in'></i> Login
                    </button>
                </form>
                <div id="login-error" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; margin-top: 20vh;">
            <div class="modal-header">
                <h2 id="confirm-title" class="text-xl font-bold text-[var(--text-heading)]">Confirm Action</h2>
            </div>
            <div class="p-6">
                <p id="confirm-message" class="text-[var(--text-body)]">Are you sure?</p>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="confirm-cancel" class="share-btn bg-gray-500 hover:bg-gray-600">Cancel</button>
                    <button id="confirm-ok" class="share-btn bg-red-600 hover:bg-red-700">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="admin-panel">
        <div class="admin-header">
            <h1 class="text-xl md:text-2xl font-bold text-[var(--text-heading)]">Admin Panel</h1>
            <div class="flex flex-wrap items-center gap-2 md:gap-4">
                <span id="admin-user" class="text-[var(--text-muted)] text-sm"></span>
                <button id="save-article" class="share-btn">
                    <i class='bx bx-save'></i> Save
                </button>
                <button id="logout-btn" class="share-btn bg-yellow-500">
                    <i class='bx bx-log-out'></i> Logout
                </button>
                <button id="close-admin" class="share-btn bg-gray-500">
                    <i class='bx bx-x'></i> Close
                </button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row" style="height: calc(100vh - 65px);">
            <div
                class="w-full md:w-1/2 p-4 overflow-y-auto border-b-2 md:border-b-0 md:border-r-2 border-[var(--border-color)]">
                <h2 class="text-xl font-bold text-[var(--text-heading)] mb-4">Create/Edit Article</h2>
                <form id="article-form">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="article-title" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Excerpt</label>
                        <textarea id="article-excerpt" class="form-input" rows="3"
                            placeholder="Brief description of the article..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <div id="tags-container"
                            class="flex flex-wrap gap-2 items-center min-h-[40px] p-2 border-2 border-[var(--border-color)] rounded-md bg-[var(--bg-card)] cursor-text">
                            <input type="text" id="tag-input"
                                class="border-none outline-none bg-transparent text-[var(--text-body)] flex-1 min-w-[100px]"
                                placeholder="Press Enter to add tags...">
                        </div>
                    </div>

                    <div class="toolbar">
                        <button type="button" class="toolbar-btn" onclick="insertFormat('**', '**', 'Bold text')"><i
                                class='bx bx-bold'></i> Bold</button>
                        <button type="button" class="toolbar-btn" onclick="insertFormat('*', '*', 'Italic text')"><i
                                class='bx bx-italic'></i> Italic</button>
                        <button type="button" class="toolbar-btn" onclick="insertFormat('`', '`', 'code')"><i
                                class='bx bx-code'></i> Code</button>
                        <button type="button" class="toolbar-btn" onclick="insertLink()"><i class='bx bx-link'></i>
                            Link</button>
                        <button type="button" class="toolbar-btn"
                            onclick="insertFormat('\n```\n', '\n```\n', 'code block')"><i class='bx bx-code-block'></i>
                            Block</button>
                        <button type="button" class="toolbar-btn" onclick="insertHumorText()"><i
                                class='bx bx-smile'></i> Humor</button>
                        <button type="button" class="toolbar-btn" onclick="insertHR()"><i class='bx bx-minus'></i>
                            HR</button>
                        <button type="button" class="toolbar-btn" onclick="insertHeading('## ')">H2</button>
                        <button type="button" class="toolbar-btn" onclick="insertHeading('### ')">H3</button>
                        <button type="button" class="toolbar-btn" onclick="insertList('- ')"><i
                                class='bx bx-list-ul'></i> List</button>
                        <button type="button" class="toolbar-btn" onclick="insertQuote()"><i
                                class='bx bx-quote-right'></i> Quote</button>
                        <button type="button" class="toolbar-btn" onclick="insertImage()"><i class='bx bx-image'></i>
                            Image</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Content (Markdown)</label>
                        <textarea id="article-content" class="form-textarea"
                            placeholder="Write your article content in Markdown..."></textarea>
                    </div>
                </form>
            </div>

            <div class="w-full md:w-1/2 p-4 overflow-y-auto">
                <h2 class="text-xl font-bold text-[var(--text-heading)] mb-4">Live Preview</h2>
                <div id="preview-container" class="article-content">
                    <p class="text-[var(--text-muted)]">Preview will appear here as you type...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAbXdJRgirJTehgW-kpUMYdTjGw_hFvfkY",
            authDomain: "blog-ffec3.firebaseapp.com",
            projectId: "blog-ffec3",
            storageBucket: "blog-ffec3.firebasestorage.app",
            messagingSenderId: "521676827644",
            appId: "1:521676827644:web:2f7867d4caaf25142ae079",
            measurementId: "G-CR5PQX8GHZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // --- Global variables ---
        let allArticles = [];
        let currentArticle = null;
        let editingArticleId = null;
        let tags = [];
        let currentUser = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            initializeTheme();
            initializeAuth();
            loadArticles();
            setupEventListeners();
            setupAdminPanel();
        });

        // --- AUTHENTICATION ---
        function initializeAuth() {
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                updateUIForAuth();
                displayArticles(allArticles);
            });
        }
        // --- AUTO-SAVE DRAFT FUNCTIONS ---

        function saveDraft() {
            console.log('Saving draft to localStorage...');
            try {
                localStorage.setItem('blogDraftTitle', document.getElementById('article-title').value);
                localStorage.setItem('blogDraftExcerpt', document.getElementById('article-excerpt').value);
                localStorage.setItem('blogDraftContent', document.getElementById('article-content').value);

                // Collect and save tags
                const currentTags = Array.from(document.querySelectorAll('#tags-container .tag-item span:first-child')).map(tag => tag.textContent);
                localStorage.setItem('blogDraftTags', JSON.stringify(currentTags));
            } catch (e) {
                console.error("Could not save draft to localStorage.", e);
            }
        }

        function loadDraft() {
            console.log('Checking for a saved draft...');
            const title = localStorage.getItem('blogDraftTitle');
            const excerpt = localStorage.getItem('blogDraftExcerpt');
            const content = localStorage.getItem('blogDraftContent');
            const tagsJson = localStorage.getItem('blogDraftTags');

            if (title || excerpt || content || tagsJson) {
                if (confirm('A saved draft was found. Do you want to load it?')) {
                    document.getElementById('article-title').value = title || '';
                    document.getElementById('article-excerpt').value = excerpt || '';
                    document.getElementById('article-content').value = content || '';

                    // Clear existing tags before loading draft
                    document.querySelectorAll('#tags-container .tag-item').forEach(el => el.remove());
                    if (tagsJson) {
                        const tagsArray = JSON.parse(tagsJson);
                        tagsArray.forEach(tag => addTag(tag));
                    }

                    // Update the live preview with the loaded content
                    updatePreview();
                    showNotification('Draft loaded successfully!');
                }
            }
        }

        function clearDraft() {
            console.log('Clearing saved draft from localStorage.');
            localStorage.removeItem('blogDraftTitle');
            localStorage.removeItem('blogDraftExcerpt');
            localStorage.removeItem('blogDraftContent');
            localStorage.removeItem('blogDraftTags');
        }
        function updateUIForAuth() {
            const adminToggle = document.getElementById('admin-toggle');
            const adminToggleMobile = document.getElementById('admin-toggle-mobile');
            const adminUser = document.getElementById('admin-user');
            const logoutBtn = document.getElementById('logout-btn');

            if (currentUser) {
                adminToggle.textContent = 'Admin Panel';
                adminToggleMobile.textContent = 'Admin Panel';
                adminUser.textContent = `Welcome, ${currentUser.email.split('@')[0]}`;
                logoutBtn.style.display = 'inline-flex';
            } else {
                adminToggle.textContent = 'Admin Login';
                adminToggleMobile.textContent = 'Admin Login';
                adminUser.textContent = '';
                logoutBtn.style.display = 'none';
            }
        }

        function toggleAdminPanel() {
            if (currentUser) {
                const adminPanel = document.getElementById('admin-panel');
                adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
                if (adminPanel.style.display === 'block') {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'auto';
                }
            } else {
                showLoginModal();
            }
        }

        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideLoginModal() {
            const loginModal = document.getElementById('login-modal');
            loginModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('login-form').reset();
            document.getElementById('login-error').style.display = 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');
            loginError.style.display = 'none';
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Logging in...';
            loginBtn.disabled = true;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                hideLoginModal();
                showNotification('Logged in successfully!');
                setTimeout(() => {
                    const adminPanel = document.getElementById('admin-panel');
                    adminPanel.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }, 300);
            } catch (error) {
                loginError.textContent = getAuthErrorMessage(error.code);
                loginError.style.display = 'block';
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                closeAdminPanel();
                showNotification('Logged out successfully');
            } catch (error) {
                showNotification('Error logging out', 'error');
            }
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found': return 'No user found with this email address.';
                case 'auth/wrong-password': return 'Incorrect password.';
                default: return 'Login failed. Please check your credentials.';
            }
        }

        // --- THEME MANAGEMENT ---
        function initializeTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const toggleIcon = themeToggle.querySelector('i');
            const currentTheme = localStorage.getItem('theme') || 'default';
            if (currentTheme === 'rose') {
                document.body.classList.add('theme-rose');
                toggleIcon.classList.replace('bxs-moon', 'bxs-sun');
            }
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('theme-rose');
                let theme = document.body.classList.contains('theme-rose') ? 'rose' : 'default';
                toggleIcon.classList.toggle('bxs-moon');
                toggleIcon.classList.toggle('bxs-sun');
                localStorage.setItem('theme', theme);
            });
        }

        // --- ARTICLE MANAGEMENT ---
        async function loadArticles() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('no-results').style.display = 'none';
            try {
                const snapshot = await db.collection('articles').orderBy('createdAt', 'desc').get();
                allArticles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayArticles(allArticles);
                generateTagFilters();
            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('no-results').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayArticles(articles) {
            const articlesGrid = document.getElementById('articles-grid');
            const noResults = document.getElementById('no-results');

            if (articles.length === 0) {
                noResults.style.display = 'block';
                articlesGrid.innerHTML = '';
                return;
            }

            noResults.style.display = 'none';
            articlesGrid.innerHTML = articles.map(article => `
            <article class="blog-card fade-in" onclick="openArticle('${article.id}')">
                <div class="flex flex-wrap gap-2 mb-4">
                    ${article.tags.map(tag => `<span class="tech-tag">${tag}</span>`).join('')}
                </div>
                <p class="blog-meta">${formatDate(article.createdAt.toDate())} • ${calculateReadTime(article.content)} min read</p>
                <h3 class="blog-title text-xl md:text-2xl">${article.title}</h3>
                <p class="text-[var(--text-body)]">${article.excerpt}</p>
                <div class="flex justify-between items-center mt-6">
                    <span class="font-semibold text-[var(--accent-color)]">Read Article →</span>
                    <div class="flex gap-2">
                        ${currentUser ? `
                        <button class="text-[var(--text-muted)] hover:text-[var(--accent-color)] text-lg" 
                                title="Edit Article" 
                                onclick="event.stopPropagation(); editArticle('${article.id}')">
                            <i class='bx bxs-edit'></i>
                        </button>
                        <button class="text-[var(--text-muted)] hover:text-red-500 text-lg" 
                                title="Delete Article" 
                                onclick="event.stopPropagation(); deleteArticle('${article.id}')">
                            <i class='bx bxs-trash'></i>
                        </button>
                        ` : ''}
                        <button class="text-[var(--text-muted)] hover:text-[var(--accent-color)] text-lg" 
                                title="Share Article" 
                                onclick="event.stopPropagation(); shareArticle('copy', '${article.id}')">
                            <i class='bx bx-share'></i>
                        </button>
                    </div>
                </div>
            </article>
        `).join('');
        }

        function generateTagFilters() {
            const tagFilterContainer = document.getElementById('tag-filter');
            const allTags = [...new Set(allArticles.flatMap(article => article.tags))];
            tagFilterContainer.innerHTML = `
            <button class="tech-tag cursor-pointer tag-filter active" onclick="filterByTag('all', this)">All</button>
            ${allTags.map(tag => `<button class="tech-tag cursor-pointer tag-filter" onclick="filterByTag('${tag}', this)">${tag}</button>`).join('')}
        `;
        }

        function filterByTag(tag, element) {
            document.querySelectorAll('.tag-filter').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            const filtered = tag === 'all' ? allArticles : allArticles.filter(article => article.tags.includes(tag));
            displayArticles(filtered);
        }

        // --- EVENT LISTENERS & MODALS ---
        function setupEventListeners() {
            // Mobile Menu Toggle
            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                const menu = document.getElementById('mobile-menu');
                const icon = document.getElementById('mobile-menu-icon');
                menu.classList.toggle('hidden');
                if (menu.classList.contains('hidden')) {
                    icon.classList.remove('bx-x');
                    icon.classList.add('bx-menu');
                } else {
                    icon.classList.remove('bx-menu');
                    icon.classList.add('bx-x');
                }
            });

            document.getElementById('search-input').addEventListener('input', debounce(performSearch, 300));
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('article-modal').addEventListener('click', (e) => e.target.id === 'article-modal' && closeModal());
            document.getElementById('close-login').addEventListener('click', hideLoginModal);
            document.getElementById('login-modal').addEventListener('click', (e) => e.target.id === 'login-modal' && hideLoginModal());
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('admin-toggle').addEventListener('click', toggleAdminPanel);
            document.getElementById('admin-toggle-mobile').addEventListener('click', toggleAdminPanel);
            document.getElementById('close-admin').addEventListener('click', () => {
                resetAdminForm();
                closeAdminPanel();
            });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const filtered = !query ? allArticles : allArticles.filter(article =>
                article.title.toLowerCase().includes(query) ||
                article.content.toLowerCase().includes(query) ||
                article.tags.some(tag => tag.toLowerCase().includes(query))
            );
            displayArticles(filtered);
        }

        async function openArticle(articleId) {
            const article = allArticles.find(a => a.id === articleId);
            if (!article) return;
            currentArticle = article;
            document.getElementById('modal-title').textContent = article.title;
            document.getElementById('modal-date').textContent = `${formatDate(article.createdAt.toDate())} • ${calculateReadTime(article.content)} min read`;
            document.getElementById('modal-tags').innerHTML = article.tags.map(tag => `<span class="tech-tag">${tag}</span>`).join('');
            document.getElementById('modal-content-body').innerHTML = renderMarkdown(article.content);
            Prism.highlightAll();
            document.getElementById('article-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.querySelector('#article-modal .modal-content').classList.add('slide-up');
        }

        function closeModal() {
            document.getElementById('article-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // --- ADMIN PANEL & EDITING ---
        function setupAdminPanel() {
            // --- Existing code ---
            const tagInput = document.getElementById('tag-input');
            const tagsContainer = document.getElementById('tags-container');

            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    e.preventDefault();
                    addTag(e.target.value.trim());
                    e.target.value = '';
                    saveDraft(); // Save when a tag is added
                }
            });

            // Handle tag removal and save draft
            tagsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tag-remove')) {
                    e.target.parentElement.remove();
                    saveDraft(); // Save when a tag is removed
                }
            });

            // --- Auto-save listeners ---
            const debouncedSave = debounce(saveDraft, 500); // Save draft 500ms after user stops typing
            document.getElementById('article-title').addEventListener('input', debouncedSave);
            document.getElementById('article-excerpt').addEventListener('input', debouncedSave);
            document.getElementById('article-content').addEventListener('input', () => {
                debouncedSave();
                debounce(updatePreview, 300)(); // Also trigger preview update
            });

            // --- Keep existing event listener for saving the final article ---
            document.getElementById('save-article').addEventListener('click', saveArticle);

            // --- Load draft when admin panel is initialized ---
            loadDraft();
        }

        function closeAdminPanel() {
            document.getElementById('admin-panel').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function addTag(tagText) {
            const container = document.getElementById('tags-container');
            const input = document.getElementById('tag-input');
            const existingTags = Array.from(container.querySelectorAll('.tag-item')).map(tag => tag.dataset.tag);
            if (existingTags.includes(tagText.toLowerCase())) return;

            const tagElement = document.createElement('div');
            tagElement.className = 'tag-item bg-[var(--accent-subtle)] text-[var(--accent-text)] px-3 py-1 rounded-full text-sm flex items-center gap-2';
            tagElement.dataset.tag = tagText.toLowerCase();
            tagElement.innerHTML = `<span>${tagText}</span> <span class="tag-remove cursor-pointer font-bold" onclick="this.parentElement.remove()">&times;</span>`;
            container.insertBefore(tagElement, input);
        }

        function editArticle(articleId) {
            if (!currentUser) return;
            const article = allArticles.find(a => a.id === articleId);
            if (!article) return;

            editingArticleId = article.id;
            document.getElementById('article-title').value = article.title;
            document.getElementById('article-excerpt').value = article.excerpt;
            document.getElementById('article-content').value = article.content;

            const tagsContainer = document.getElementById('tags-container');
            tagsContainer.querySelectorAll('.tag-item').forEach(el => el.remove());
            article.tags.forEach(tag => addTag(tag));

            updatePreview();
            toggleAdminPanel();
        }

        function deleteArticle(articleId) {
            if (!currentUser) return;

            showConfirmation('Are you sure you want to delete this article? This cannot be undone.', async () => {
                try {
                    await db.collection('articles').doc(articleId).delete();
                    showNotification('Article deleted successfully!');
                    await loadArticles();
                } catch (error) {
                    showNotification('Error deleting article: ' + error.message, 'error');
                }
            });
        }

        async function saveArticle() {
            if (!currentUser) {
                showNotification('Please login to save articles', 'error');
                return;
            }
            const title = document.getElementById('article-title').value.trim();
            const content = document.getElementById('article-content').value.trim();
            if (!title || !content) {
                showNotification('Title and Content are required', 'error');
                return;
            }
            const excerpt = document.getElementById('article-excerpt').value.trim();
            const tags = Array.from(document.querySelectorAll('#tags-container .tag-item span:first-child')).map(tag => tag.textContent);
            const saveBtn = document.getElementById('save-article');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Saving...';
            saveBtn.disabled = true;

            try {
                const articleData = {
                    title,
                    excerpt: excerpt || content.substring(0, 150) + "...",
                    content,
                    tags: tags.length ? tags : ['general'],
                    updatedAt: firebase.firestore.Timestamp.now(),
                    author: currentUser.email
                };

                if (editingArticleId) {
                    await db.collection('articles').doc(editingArticleId).update(articleData);
                    showNotification('Article updated successfully!');
                } else {
                    articleData.createdAt = firebase.firestore.Timestamp.now();
                    await db.collection('articles').add(articleData);
                    showNotification('Article saved successfully!');
                }
                resetAdminForm();
                clearDraft(); // <-- ADD THIS LINE to clear the draft on successful save
                closeAdminPanel();
                await loadArticles();
            } catch (error) {
                showNotification('Error saving article: ' + error.message, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function resetAdminForm() {
            editingArticleId = null;
            document.getElementById('article-form').reset();
            document.querySelectorAll('.tag-item').forEach(e => e.remove());
            updatePreview();
            clearDraft(); // <-- ADD THIS LINE
            showNotification('Form and saved draft have been cleared.'); // <-- Optional: add feedback
        }

        // --- TOOLBAR & MARKDOWN ---
        function insertFormat(startTag, endTag, placeholder) {
            const textarea = document.getElementById('article-content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end) || placeholder;
            const replacement = startTag + selectedText + endTag;
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + startTag.length, start + startTag.length + selectedText.length);
            updatePreview();
        }

        function insertLink() { const url = prompt('Enter link URL:'); if (url) insertFormat('[', `](${url})`, 'Link Text'); }
        function insertHumorText() { insertFormat(' <span class="humor-text">(', ')</span>', 'witty comment'); }
        function insertHR() { insertFormat('\n\n---\n\n', '', ''); }
        function insertHeading(prefix) { insertFormat('\n' + prefix, '', 'Heading'); }
        function insertList(prefix) { insertFormat('\n' + prefix, '', 'List item'); }
        function insertQuote() { insertFormat('\n> ', '', 'Quote'); }
        function insertImage() { const url = prompt('Enter image URL:'); if (url) { const alt = prompt('Enter alt text:') || 'image'; insertFormat(`\n![${alt}](${url})\n`, '', ''); } }

        function updatePreview() {
            const title = document.getElementById('article-title').value;
            const content = document.getElementById('article-content').value;
            const previewContainer = document.getElementById('preview-container');
            let previewHTML = `<h1 class="text-3xl md:text-4xl font-bold mb-4">${title}</h1>` + renderMarkdown(content);
            previewContainer.innerHTML = previewHTML || '<p class="text-[var(--text-muted)]">Preview will appear here...</p>';
            Prism.highlightAllUnder(previewContainer);
        }

        function renderMarkdown(content) {
            const renderer = new marked.Renderer();
            renderer.code = (code, language) => `<pre><code class="language-${language || 'markup'}">${code}</code></pre>`;
            renderer.blockquote = (quote) => `<blockquote class="bg-[var(--bg-card)] border-l-4 border-[var(--accent-color)] pl-4 md:pl-6 py-4 my-6 rounded-r-lg">${quote}</blockquote>`;
            marked.setOptions({ renderer });
            return marked.parse(content);
        }

        // --- UTILITIES ---
        function shareArticle(platform, articleId = null) {
            const article = articleId ? allArticles.find(a => a.id === articleId) : currentArticle;
            if (!article) return;
            const url = `${window.location.origin}${window.location.pathname}?article=${article.id}`;
            const text = encodeURIComponent(`Check out this article: ${article.title}`);
            if (platform === 'copy') {
                navigator.clipboard.writeText(url).then(() => showNotification('Link copied!'));
            } else if (platform === 'twitter') {
                window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
            } else if (platform === 'linkedin') {
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
            }
        }

        function showConfirmation(message, callback) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = message;
            modal.style.display = 'block';

            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');

            const close = () => modal.style.display = 'none';

            const okListener = () => {
                callback();
                close();
            };

            okBtn.onclick = okListener;
            cancelBtn.onclick = close;
        }

        function formatDate(date) { return date.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }); }
        function calculateReadTime(content) { return Math.ceil(content.split(' ').length / 200); }
        function debounce(func, wait) { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; }
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-[9999] p-4 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white font-medium`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Handle direct article links on page load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('article');
            if (articleId) {
                const checkArticlesLoaded = setInterval(() => {
                    if (allArticles.length > 0) {
                        openArticle(articleId);
                        clearInterval(checkArticlesLoaded);
                    }
                }, 100);
            }
        });
    </script>
</body>

</html>